<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detractio â€” Retirement Calculator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="professional-forms.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¥ Detractio</h1>
            <div class="slogan-container">
                <span class="slogan-icon">ğŸ’·</span>
                <p class="subtitle">Because Timing Your Withdrawal Matters</p>
                <span class="slogan-subtext">Serious financial modelling. Delivered with a wink.</span>
            </div>
            <p class="version">v0.4.1</p>
            <a href="index.html" class="view-features-link">ğŸ  Home</a>
            <a href="functionality.html" class="view-features-link" style="margin-left:8px;">ğŸ“‹ Features</a>
            <a href="tests.html" class="view-features-link" style="margin-left:8px;">ğŸ§ª Test Suite</a>
            <a href="login.html" class="view-features-link" style="margin-left:8px;" id="headerAuthLink">ğŸ”‘ Login</a>
        </header>

        <!-- Calculator Form -->
        <section id="calculator-form" class="card">
            <h2>Retirement Planning Calculator</h2>

            <!-- Save / Load Bar (visible when logged in) -->
            <div id="saveLoadBar" class="save-load-bar" style="display: none;">
                <button id="saveDataBtn" class="save-load-btn" title="Save your inputs">ğŸ’¾ Save</button>
                <button id="loadDataBtn" class="save-load-btn" title="Load your saved inputs">ğŸ“‚ Load</button>
                <span id="saveLoadMsg" class="save-load-msg" style="display: none;"></span>
            </div>

            <!-- Wizard Progress Bar -->
            <div class="wizard-progress" id="wizardProgress">
                <div class="wizard-step-indicator active" data-step="1">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-label">Timeline</span>
                </div>
                <div class="wizard-step-connector"></div>
                <div class="wizard-step-indicator" data-step="2">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-label">Pension</span>
                </div>
                <div class="wizard-step-connector"></div>
                <div class="wizard-step-indicator" data-step="3">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-label">Spending</span>
                </div>
                <div class="wizard-step-connector"></div>
                <div class="wizard-step-indicator" data-step="4">
                    <span class="wizard-step-number">4</span>
                    <span class="wizard-step-label">Assumptions</span>
                </div>
                <div class="wizard-step-connector"></div>
                <div class="wizard-step-indicator" data-step="5">
                    <span class="wizard-step-number">5</span>
                    <span class="wizard-step-label">Income</span>
                </div>
            </div>

            <!-- Step 1 of 5 -->
            <div class="wizard-step" data-step="1">
            <!-- Date Information Section -->
            <div class="date-section">
                <div class="section-header">
                    <h3>Step 1: Your Age & Retirement Timeline</h3>
                    <p class="section-description">Enter your details to calculate retirement timeline and life expectancy</p>
                </div>
                
                <div class="date-input-grid">
                    <div class="date-input-box">
                        <label for="birthDate">Date of Birth</label>
                        <input type="date" id="birthDate" required>
                        <p class="input-hint">Required to calculate your retirement date</p>
                    </div>

                    <div class="date-input-box">
                        <label for="genderSelect">Gender</label>
                        <select id="genderSelect" class="age-select" required>
                            <option value="">Select gender...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <p class="input-hint">Used for life expectancy estimate</p>
                    </div>

                    <div class="date-input-box">
                        <label for="retirementAgeSelect">Target Retirement Age</label>
                        <select id="retirementAgeSelect" class="age-select">
                            <option value="">Select retirement age...</option>
                            <option value="55">55 years (UK minimum)</option>
                            <option value="60">60 years</option>
                            <option value="65">65 years (standard UK state pension)</option>
                            <option value="67">67 years</option>
                            <option value="68">68 years</option>
                            <option value="70">70 years</option>
                        </select>
                        <p class="input-hint">Your target retirement age</p>
                    </div>

                    <div class="date-input-box">
                        <label for="postcode">Postcode <span class="optional-label">(optional)</span></label>
                        <input type="text" id="postcode" placeholder="e.g. SW1A 1AA" maxlength="8" autocomplete="postal-code">
                        <p class="input-hint">Refines life expectancy by region</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Your Current Age</label>
                    <p class="input-hint" id="currentAge">Enter your date of birth to calculate</p>
                </div>

                <!-- Life Expectancy / Planning Horizon -->
                <div class="form-group life-expectancy-display" id="lifeExpectancyGroup">
                    <label>ğŸ“Š Plan To Age</label>
                    <p class="input-hint" style="margin-bottom: 10px;">How far ahead should we project your retirement funds?</p>
                    <div class="le-options">
                        <label class="le-option">
                            <input type="radio" name="lifeExpectancyMode" value="ons" checked>
                            <span class="le-option-label">ğŸ›ï¸ ONS Life Expectancy</span>
                            <span class="le-option-desc">Based on your gender, age &amp; postcode</span>
                        </label>
                        <label class="le-option">
                            <input type="radio" name="lifeExpectancyMode" value="default">
                            <span class="le-option-label">ğŸ“… Default (Age 100)</span>
                            <span class="le-option-desc">Standard planning horizon</span>
                        </label>
                        <label class="le-option">
                            <input type="radio" name="lifeExpectancyMode" value="manual">
                            <span class="le-option-label">âœï¸ Manual</span>
                            <span class="le-option-desc">Enter your own target age</span>
                        </label>
                    </div>
                    <div id="manualAgeInput" style="display: none; margin-top: 10px;">
                        <label for="manualTargetAge">Target Age</label>
                        <input type="number" id="manualTargetAge" min="60" max="120" value="90" step="1">
                    </div>
                    <div class="le-result" id="lifeExpectancyResult">
                        <p class="life-expectancy-value" id="lifeExpectancyValue"></p>
                        <p class="input-hint" id="lifeExpectancySource"></p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="retirementDate">Planned Retirement Date</label>
                    <input type="date" id="retirementDate" required>
                    <p class="input-hint">Auto-calculated from your DOB &amp; retirement age, or override manually</p>
                </div>
            </div>
            </div><!-- /wizard-step 1 -->

            <!-- Step 2 of 5 -->
            <div class="wizard-step" data-step="2" style="display:none">
            <div class="financial-section">
                <div class="section-header">
                    <h3>Step 2: Your Pension Details</h3>
                    <p class="section-description">Enter your current savings and expected contributions</p>
                </div>
                
                <div class="form-group">
                    <label for="currentPot">Current Pension Pot (Â£)</label>
                    <input type="text" inputmode="numeric" id="currentPot" placeholder="e.g. 50,000" required>
                    <p class="input-hint">Your current pension savings</p>
                </div>

                <div class="form-group">
                    <label for="monthlyContribution">Monthly Contribution (Â£)</label>
                    <input type="text" inputmode="numeric" id="monthlyContribution" placeholder="e.g. 500" required>
                    <p class="input-hint">Amount you contribute each month</p>
                </div>
            </div>
            </div><!-- /wizard-step 2 -->

            <!-- Step 3 of 5 -->
            <div class="wizard-step" data-step="3" style="display:none">
            <section id="longevityPlanning" class="financial-section">
                <div class="section-header">
                    <h3>Step 3: Retirement Spending</h3>
                    <p class="section-description">How much do you plan to withdraw each year? Go onâ€¦ take a little out.</p>
                </div>
                <div class="form-group">
                    <label for="retirementAnnualSpending">Annual Retirement Spending (Â£)</label>
                    <input type="text" inputmode="numeric" id="retirementAnnualSpending" placeholder="e.g. 40,000">
                    <p class="spending-hint" id="spendingSuggestion">We'll suggest a figure based on the 4% safe withdrawal rate after you calculate</p>
                </div>
            </section>
            </div><!-- /wizard-step 3 -->

            <!-- Step 4 of 5 -->
            <div class="wizard-step" data-step="4" style="display:none">
            <div class="financial-section">
                <div class="section-header">
                    <h3>Step 4: Your Assumptions</h3>
                    <p class="section-description">Tweak the numbers that drive the engine â€” or trust the defaults, they're pretty solid.</p>
                </div>

                <!-- Inflation -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeInflation" checked>
                        <span>Include Inflation Adjustment</span>
                    </label>
                    <p class="input-hint">Show results in today's pounds (real values) vs future pounds (nominal values)</p>
                </div>

                <div class="form-group" id="inflationRateGroup">
                    <label for="inflationRate">Inflation Rate</label>
                    <div class="input-suffix">
                        <input type="number" id="inflationRate" min="0" max="5" step="0.1" value="2.5" placeholder="2.5">
                        <span class="suffix-symbol">%</span>
                    </div>
                    <p class="input-hint">Default 2.5% based on UK average. Range: 0%â€“5%</p>
                </div>

                <!-- Scenario Growth Rates -->
                <div class="form-group">
                    <label>ğŸ“Š Growth Scenarios â€” your three futures</label>
                    <p class="form-hint">We compare Weak, Average and Strong growth side by side. Override the rates if you fancy, but keep them in order.</p>

                    <div class="scenario-buttons">
                        <div class="scenario-card-editable scenario-weak" id="scenarioWeakCard">
                            <span class="scenario-card-icon">ğŸ”´</span>
                            <span class="scenario-card-title">Weak</span>
                            <div class="scenario-card-rate">
                                <input type="number" id="scenarioWeakRate" min="0" max="15" step="0.1" value="2" class="scenario-rate-input" aria-label="Weak growth rate">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="scenario-card-hint">Conservative / cautious</p>
                        </div>

                        <div class="scenario-card-editable scenario-average active" id="scenarioAverageCard">
                            <span class="scenario-card-icon">ğŸŸ¢</span>
                            <span class="scenario-card-title">Average</span>
                            <div class="scenario-card-rate">
                                <input type="number" id="scenarioAverageRate" min="0" max="15" step="0.1" value="5" class="scenario-rate-input" aria-label="Average growth rate">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="scenario-card-hint">Typical UK equities</p>
                        </div>

                        <div class="scenario-card-editable scenario-strong" id="scenarioStrongCard">
                            <span class="scenario-card-icon">ğŸŸ¡</span>
                            <span class="scenario-card-title">Strong</span>
                            <div class="scenario-card-rate">
                                <input type="number" id="scenarioStrongRate" min="0" max="15" step="0.1" value="8" class="scenario-rate-input" aria-label="Strong growth rate">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="scenario-card-hint">Optimistic / bullish</p>
                        </div>
                    </div>

                    <p class="form-hint" id="scenarioValidationMsg" style="color: #dc3545; display: none;">âš ï¸ Rates must go up: Weak &lt; Average &lt; Strong</p>
                    <p class="form-hint">Click a scenario to set your primary growth rate. The selected one drives the main projection.</p>
                </div>

                <!-- Platform & Fees (Optional) -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeFees">
                        <span>ğŸ’¸ Include Platform &amp; Fund Fees</span>
                    </label>
                    <p class="input-hint">Fees eat into your growth every year. Add them here for a more realistic projection.</p>
                </div>

                <div id="feesSection" style="display: none;">
                    <div class="fees-grid">
                        <div class="fee-card">
                            <span class="fee-card-icon">ğŸ¦</span>
                            <label for="platformFee" class="fee-card-title">Platform Fee</label>
                            <div class="fee-card-rate">
                                <input type="number" id="platformFee" min="0" max="3" step="0.01" value="0.25" class="fee-rate-input" aria-label="Platform fee">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="fee-card-hint">e.g. Hargreaves Lansdown, AJ Bell, Vanguard</p>
                        </div>

                        <div class="fee-card">
                            <span class="fee-card-icon">ğŸ“¦</span>
                            <label for="fundFee" class="fee-card-title">Fund / OCF Fee</label>
                            <div class="fee-card-rate">
                                <input type="number" id="fundFee" min="0" max="3" step="0.01" value="0.15" class="fee-rate-input" aria-label="Fund management fee">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="fee-card-hint">Ongoing Charge Figure on your fund(s)</p>
                        </div>

                        <div class="fee-card">
                            <span class="fee-card-icon">ğŸ¤</span>
                            <label for="adviserFee" class="fee-card-title">Adviser Fee</label>
                            <div class="fee-card-rate">
                                <input type="number" id="adviserFee" min="0" max="3" step="0.01" value="0" class="fee-rate-input" aria-label="Adviser fee">
                                <span class="suffix-symbol">%</span>
                            </div>
                            <p class="fee-card-hint">Annual IFA / adviser charge (if any)</p>
                        </div>
                    </div>

                    <div class="fees-summary" id="feesSummary">
                        <span class="fees-summary-label">Total Annual Fees:</span>
                        <span class="fees-summary-value" id="totalFeeDisplay">0.40%</span>
                        <span class="fees-summary-note">â€” deducted from growth each year</span>
                    </div>
                </div>

                <!-- Hidden field that receives the selected rate (replaces old investmentGrowth) -->
                <input type="hidden" id="investmentGrowth" value="5">
            </div>
            </div><!-- /wizard-step 4 -->

            <!-- Step 5 of 5 -->
            <div class="wizard-step" data-step="5" style="display:none">
            <div class="financial-section">
                <div class="section-header">
                    <h3>Step 5: Other Income</h3>
                    <p class="section-description">Got money coming in from elsewhere? State pension, DB pensions, rentalsâ€¦ it all counts. Less to withdraw from your pot.</p>
                </div>

                <!-- State Pension â€” always visible, everyone gets this -->
                <div class="state-pension-section">
                    <div class="income-source-card state-pension-card">
                        <span class="income-source-icon">ğŸ›ï¸</span>
                        <label class="income-source-title">State Pension</label>

                        <div class="sp-qualifying-row">
                            <label for="spQualifyingYears" class="sp-years-label">NI qualifying years</label>
                            <div class="sp-years-control">
                                <input type="range" id="spQualifyingYears" min="0" max="35" value="35" step="1" aria-label="NI qualifying years">
                                <output id="spYearsDisplay" class="sp-years-value">35</output>
                            </div>
                            <p class="sp-years-hint" id="spYearsHint">35 years = full pension</p>
                        </div>

                        <div class="income-source-input">
                            <span class="prefix-symbol">Â£</span>
                            <input type="text" inputmode="numeric" id="statePension" placeholder="11,502" class="income-source-amount" aria-label="Annual state pension">
                            <span class="sp-per-year">/yr</span>
                        </div>

                        <div class="income-start-age">
                            <label for="statePensionAge" class="start-age-label">Starts at age</label>
                            <input type="number" id="statePensionAge" value="67" min="55" max="75" class="start-age-input" aria-label="State pension start age">
                        </div>
                        <p class="income-source-hint">Full new state pension Â£11,502/yr (2025/26). Need min 10 years to qualify.</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeOtherIncome">
                        <span>ğŸ’° I have additional retirement income</span>
                    </label>
                    <p class="input-hint">DB pensions, annuities, rental income or other sources that reduce your pot withdrawals</p>
                </div>

                <div id="otherIncomeSection" style="display: none;">
                    <div class="other-income-grid">
                        <div class="income-source-card">
                            <span class="income-source-icon">ğŸ¢</span>
                            <label for="dbPension" class="income-source-title">DB / Final Salary Pension</label>
                            <div class="income-source-input">
                                <span class="prefix-symbol">Â£</span>
                                <input type="text" inputmode="numeric" id="dbPension" placeholder="0" class="income-source-amount" aria-label="Annual DB pension">
                            </div>
                            <div class="income-start-age">
                                <label for="dbPensionAge" class="start-age-label">Starts at age</label>
                                <input type="number" id="dbPensionAge" value="65" min="50" max="75" class="start-age-input" aria-label="DB pension start age">
                            </div>
                            <p class="income-source-hint">Defined Benefit pension income per year</p>
                        </div>

                        <div class="income-source-card">
                            <span class="income-source-icon">ğŸ”’</span>
                            <label for="annuityIncome" class="income-source-title">Annuity Income</label>
                            <div class="income-source-input">
                                <span class="prefix-symbol">Â£</span>
                                <input type="text" inputmode="numeric" id="annuityIncome" placeholder="0" class="income-source-amount" aria-label="Annual annuity income">
                            </div>
                            <p class="income-source-hint">Purchased annuity payments per year</p>
                        </div>

                        <div class="income-source-card">
                            <span class="income-source-icon">ğŸ </span>
                            <label for="rentalIncome" class="income-source-title">Rental Income</label>
                            <div class="income-source-input">
                                <span class="prefix-symbol">Â£</span>
                                <input type="text" inputmode="numeric" id="rentalIncome" placeholder="0" class="income-source-amount" aria-label="Annual rental income">
                            </div>
                            <p class="income-source-hint">Net rental income after costs &amp; tax</p>
                        </div>

                        <div class="income-source-card">
                            <span class="income-source-icon">ğŸ“‹</span>
                            <label for="otherIncomeGeneral" class="income-source-title">Other Income</label>
                            <div class="income-source-input">
                                <span class="prefix-symbol">Â£</span>
                                <input type="text" inputmode="numeric" id="otherIncomeGeneral" placeholder="0" class="income-source-amount" aria-label="Other annual income">
                            </div>
                            <p class="income-source-hint">Part-time work, dividends, etc.</p>
                        </div>
                    </div>
                </div>

                <div class="other-income-summary" id="otherIncomeSummary">
                    <span class="other-income-summary-label">Total Other Income:</span>
                    <span class="other-income-summary-value" id="totalOtherIncomeDisplay">Â£0/yr</span>
                    <span class="other-income-summary-note" id="otherIncomeSummaryNote">â€” reduces how much you need to withdraw from your pot</span>
                </div>
            </div>
            </div><!-- /wizard-step 5 -->

            <!-- Wizard Navigation -->
            <div class="wizard-nav">
                <span class="wizard-step-counter" id="wizardStepCounter">Step 1 of 5</span>
                <div class="wizard-nav-buttons">
                    <button type="button" id="wizardPrevBtn" class="btn-secondary wizard-btn" style="display:none">â† Previous</button>
                    <button type="button" id="wizardNextBtn" class="btn-primary wizard-btn">Next â†’</button>
                    <button type="button" id="calculateBtn" class="btn-primary wizard-btn" style="display:none">ğŸ“Š Calculate My Pension</button>
                    <button type="button" id="updateResultsBtn" class="btn-primary wizard-btn" style="display:none">ğŸ”„ Update Results</button>
                </div>
            </div>
        </section>

        <!-- Results Display -->
        <section id="results" class="card" style="display: none;">
            <h2>Your Retirement Projection</h2>

            <div class="edit-inputs-bar">
                <span class="edit-inputs-label">Quick edit:</span>
                <button class="edit-step-link" data-edit-step="1">Timeline</button>
                <button class="edit-step-link" data-edit-step="2">Pension</button>
                <button class="edit-step-link" data-edit-step="3">Spending</button>
                <button class="edit-step-link" data-edit-step="4">Assumptions</button>
                <button class="edit-step-link" data-edit-step="5">Income</button>
            </div>

            <div class="inflation-badge" id="inflationBadge" style="display: none;">
                <button type="button" id="inflationToggleBtn" class="cashflow-scenario-btn" style="font-size: 0.85rem; padding: 6px 14px; border-radius: 6px; min-width: auto;">
                    ğŸ’· Showing: Today's Money
                </button>
            </div>

            <div class="other-income-badge" id="otherIncomeBadge" style="display: none;"></div>

            <!-- 3-scenario range strip â€” always visible -->
            <div class="scenario-range-strip" id="scenarioRangeStrip">
                <div class="range-scenario range-weak" data-scenario="weak">
                    <span class="range-label">ğŸ”´ Weak</span>
                    <span class="range-pot" id="rangeWeakPot">Â£0</span>
                    <span class="range-rate" id="rangeWeakRate">2%</span>
                </div>
                <div class="range-scenario range-average active" data-scenario="average">
                    <span class="range-label">ğŸŸ¢ Average</span>
                    <span class="range-pot" id="rangeAveragePot">Â£0</span>
                    <span class="range-rate" id="rangeAverageRate">5%</span>
                </div>
                <div class="range-scenario range-strong" data-scenario="strong">
                    <span class="range-label">ğŸŸ¡ Strong</span>
                    <span class="range-pot" id="rangeStrongPot">Â£0</span>
                    <span class="range-rate" id="rangeStrongRate">8%</span>
                </div>
            </div>

            <p class="results-info" id="resultsInfo">Click a scenario above to see full details</p>
            
            <div class="results-grid">
                <div class="result-card highlight">
                    <h3>ğŸ¯ Projected Pot at Retirement</h3>
                    <p class="big-number" id="projectedPot">Â£0</p>
                    <p class="sub-text" id="projectedPotReal" style="display: none;">Real value (today's pounds)</p>
                    <p class="sub-text" id="projectedPotNominal" style="display: none;">Nominal value (future pounds)</p>
                    <p class="sub-text" id="projectedPotGrowthLabel">Based on 5% annual growth</p>
                </div>

                <div class="result-card">
                    <h3>ğŸ’µ Tax-Free Lump Sum</h3>
                    <p class="big-number" id="taxFreeLump">Â£0</p>
                    <p class="sub-text">25% of your pot (UK rules)</p>
                </div>

                <div class="result-card">
                    <h3>ğŸ“Š Annual Income (4% SWR)</h3>
                    <p class="big-number" id="annualIncome">Â£0</p>
                    <p class="sub-text">Monthly: <span id="monthlyIncome">Â£0</span></p>
                    <p class="sub-text" id="incomeAlternative" style="display: none;"></p>
                </div>

                <div class="result-card">
                    <h3>ğŸ’° Total Contributions</h3>
                    <p class="big-number" id="totalContributions">Â£0</p>
                    <p class="sub-text">Initial pot + monthly contributions</p>
                </div>

                <div class="result-card">
                    <h3>ğŸ“ˆ Investment Growth</h3>
                    <p class="big-number" id="growthAmount">Â£0</p>
                    <p class="sub-text" id="growthPercentage">0% of final pot</p>
                </div>

                <div class="result-card">
                    <h3>â±ï¸ Time Horizon</h3>
                    <p class="big-number" id="yearsToRetirement">0</p>
                    <p class="sub-text">Years until retirement</p>
                </div>
            </div>

            <!-- Balance Sheet Section -->
            <section id="balanceSheetSection" class="card" style="display:none; margin-top: 32px;">
                <h3>Balance Sheet Explorer</h3>
                <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem;">
                    <label for="balanceYearSlider" style="font-weight:600;">Year:</label>
                    <input type="range" id="balanceYearSlider" min="0" max="0" value="0" step="1" style="flex:1;">
                    <output id="balanceYearValue" style="min-width: 60px; font-weight:600;">0</output>
                    <button id="balancePrevYear" class="wizard-btn" style="min-width:40px;">â†</button>
                    <button id="balanceNextYear" class="wizard-btn" style="min-width:40px;">â†’</button>
                </div>
                <div id="balanceSheetDisplay" class="balance-sheet-display"></div>
            </section>
            <!-- /Balance Sheet Section -->

            <div id="chartViewHeader" style="display: none; margin-bottom: 1rem;">
                <h3 id="mainChartTitle" style="margin-bottom: 0.15rem;">Your Detractio Fund</h3>
                <p class="chart-hint" style="margin-bottom: 0.75rem; font-style: italic; opacity: 0.7;">"Because your future self deserves more than loose change and wishful thinking."</p>
                <div class="cashflow-controls">
                    <div>
                        <div class="cashflow-scenario-toggle" id="sharedScenarioToggle">
                            <button class="cashflow-scenario-btn shared-scenario-btn" data-scenario="weak" title="Weak growth scenario">
                                <span class="scenario-dot" style="background:#dc3545"></span> Weak
                            </button>
                            <button class="cashflow-scenario-btn shared-scenario-btn active" data-scenario="average" title="Average growth scenario">
                                <span class="scenario-dot" style="background:#667eea"></span> Average
                            </button>
                            <button class="cashflow-scenario-btn shared-scenario-btn" data-scenario="strong" title="Strong growth scenario">
                                <span class="scenario-dot" style="background:#28a745"></span> Strong
                            </button>
                        </div>
                        <span class="scenario-toggle-hint">Toggle to view each growth scenario</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="chartViewSelect" style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted, #6c757d);">View:</label>
                            <select id="chartViewSelect" class="scenario-rate-input" style="min-width: 200px; padding: 0.35rem 0.5rem; font-size: 0.85rem; border-radius: 6px;">
                                <option value="lifecycle" selected>Lifecycle Projection</option>
                                <option value="cashflow">Retirement Cash Flow</option>
                            </select>
                        </div>
                        <div class="chart-age-toggle">
                            <label for="sharedAgeSlider">Plan to age:</label>
                            <input type="range" id="sharedAgeSlider" min="65" max="110" value="100" step="1">
                            <output id="sharedAgeValue" class="age-slider-value">100</output>
                            <button id="sharedAgeReset" class="age-reset-btn" title="Reset to life expectancy">â†º</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-container" id="lifecycleChartContainer" style="min-height: 450px; position: relative; display: none;">
                <p class="chart-hint" id="mainChartHint">Your complete financial journey from today through retirement</p>
                <div class="sporting-events-bar">
                    <button id="sportingEventsToggle" class="sporting-events-btn" title="Show major sporting events on your timeline">
                        ğŸ† Sporting Events
                    </button>
                    <button id="politicalEventsToggle" class="sporting-events-btn" title="Show political events on your timeline">
                        ğŸ—³ï¸ Political Events
                    </button>
                    <div id="sportingEventsSummary" class="sporting-events-summary" style="display: none;"></div>
                    <div id="politicalEventsSummary" class="sporting-events-summary" style="display: none;"></div>
                </div>
                <canvas id="growthChart"></canvas>
                <div id="dStagesLegend" class="dstages-legend" style="display: none;"></div>
                <div id="lifecycleNarrative" class="chart-narrative" style="display: none;"></div>
            </div>

            <div class="chart-container" id="cashFlowChartContainer" style="min-height: 450px; position: relative; display: none;">
                <p class="chart-hint" id="cashFlowChartHint">How your annual spending is funded each year â€” from your pot and other income sources</p>
                <canvas id="cashFlowChart"></canvas>
            </div>

                <!-- Milestone Timeline -->
                <div id="milestoneTimeline" style="display: none;" class="milestone-container">
                    <h4>Your Retirement Timeline</h4>
                    <div class="milestone-visual">
                        <div class="milestone milestone-start">
                            <div class="milestone-marker"></div>
                            <div class="milestone-label">
                                <p class="milestone-age" id="milestoneRetirementAge">Age 65</p>
                                <p class="milestone-title">Retirement</p>
                                <p class="milestone-detail" id="milestoneRetirementDate">2036</p>
                            </div>
                        </div>
                        
                        <div class="milestone-line"></div>
                        
                        <div class="milestone milestone-end">
                            <div class="milestone-marker"></div>
                            <div class="milestone-label">
                                <p class="milestone-age">Age 100</p>
                                <p class="milestone-title">Longevity Target</p>
                                <p class="milestone-detail">35 Years</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Longevity Summary -->
                <div id="longevitySummary" style="display: none;" class="longevity-summary">
                    <div class="summary-grid-longevity">
                        <div class="summary-item-longevity">
                            <p class="summary-label">Retirement Pot</p>
                            <p class="summary-value" id="longevityStartPot">Â£0</p>
                        </div>
                        <div class="summary-item-longevity">
                            <p class="summary-label">Annual Spending</p>
                            <p class="summary-value" id="longevityAnnualSpending">Â£0</p>
                        </div>
                        <div class="summary-item-longevity">
                            <p class="summary-label">Years Planned</p>
                            <p class="summary-value" id="longevityYears">35</p>
                        </div>
                        <div class="summary-item-longevity">
                            <p class="summary-label">Balance at 100</p>
                            <p class="summary-value" id="longevityFinalBalance">Â£0</p>
                        </div>
                        <div class="summary-item-longevity status-success">
                            <p class="summary-label">Status</p>
                            <p class="summary-value" id="longevityStatus">Money Lasts</p>
                        </div>
                    </div>
                </div>
            </section>

            <button id="recalculateBtn" class="btn-secondary">â†© Start Over</button>
        </section>

        <!-- Retirement Spending Analysis -->
        <section id="retirementSpending" class="card" style="display: none;">
            <h2>Retirement Spending Analysis</h2>
            <p class="form-hint">Plan how long your retirement savings will last and test different spending scenarios</p>

            <div class="spending-mode-selector">
                <label class="radio-label">
                    <input type="radio" name="spendingMode" value="mode-a" checked>
                    <span>ğŸ“Š Mode A: Spending Plan</span>
                </label>
                <p class="form-hint">Enter your planned annual spending and see if your money lasts</p>
                
                <label class="radio-label">
                    <input type="radio" name="spendingMode" value="mode-b">
                    <span>ğŸ“ˆ Mode B: Maximum Sustainable Spending</span>
                </label>
                <p class="form-hint">Discover the maximum you can safely spend each year</p>
            </div>

            <div id="modeAInputs" class="mode-inputs">
                <div class="form-group">
                    <label for="annualSpending">ğŸ’· Annual Spending Amount (Â£):</label>
                    <input type="text" inputmode="numeric" id="annualSpending" placeholder="e.g. 30,000" value="30,000">
                    <p class="form-hint">How much do you plan to spend each year in retirement?</p>
                </div>
            </div>

            <div class="form-group">
                <label for="lifeExpectancy">ğŸ‚ Life Expectancy (years):</label>
                <input type="number" id="lifeExpectancy" min="60" max="120" value="100" placeholder="100">
                <p class="form-hint">Age to plan for - conservative estimate recommended (60-120)</p>
            </div>

            <button id="analyzeSpendingBtn" class="btn-primary">Analyze Spending Plan</button>

            <div id="spendingResults" style="display: none; margin-top: 30px;">
                <div id="spendingStatus" class="spending-status-card"></div>
                
                <div class="spending-summary">
                    <h3>Retirement Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <p class="summary-label">Starting Pot</p>
                            <p class="summary-value" id="summaryStartingPot">Â£0</p>
                        </div>
                        <div class="summary-item">
                            <p class="summary-label">Annual Spending</p>
                            <p class="summary-value" id="summaryAnnualSpending">Â£0</p>
                        </div>
                        <div class="summary-item">
                            <p class="summary-label">Retirement Duration</p>
                            <p class="summary-value" id="summaryRetirementYears">0 years</p>
                        </div>
                        <div class="summary-item">
                            <p class="summary-label">Total Spent</p>
                            <p class="summary-value" id="summaryTotalSpent">Â£0</p>
                        </div>
                        <div class="summary-item">
                            <p class="summary-label">Final Balance</p>
                            <p class="summary-value" id="summaryFinalBalance">Â£0</p>
                        </div>
                        <div class="summary-item" id="summaryMoneyRunsOutContainer" style="display: none;">
                            <p class="summary-label">âš ï¸ Money Runs Out</p>
                            <p class="summary-value" id="summaryMoneyRunsOut">Age 85</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Spending Analysis Detail (Optional)</h3>
                    <p class="chart-hint">Detailed breakdown of annual spending and remaining pot - also visible in the main lifecycle chart above</p>
                    <canvas id="spendingChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Button to toggle retirement spending analysis -->
        <section id="spendingToggle" class="card" style="display: none; margin-top: 20px; text-align: center;">
            <button id="toggleSpendingAnalysisBtn" class="btn-secondary">ğŸ’° Analyze Retirement Spending Plan</button>
        </section>

        <footer>
            <p><strong>Detractio</strong> â€” The Art of a Wellâ€‘Timed Withdrawal</p>
            <p>âš ï¸ This calculator provides estimates only. Please consult a qualified financial advisor for personalised advice.</p>
            <p class="small">Â© 2026 Detractio. All rights reserved. Based on UK pension regulations as of 2025.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <!-- Data modules -->
    <script src="data/life-expectancy.js"></script>

    <!-- Utility modules -->
    <script src="utils/formatting.js"></script>
    <script src="utils/date-utils.js"></script>
    <script src="utils/drawdown.js"></script>
    <script src="utils/form-helpers.js"></script>

    <!-- Calculators -->
    <script src="calculators/pension-projection.js"></script>
    <script src="calculators/income-projection.js"></script>
    <script src="calculators/inflation-calculator.js"></script>
    <script src="calculators/retirement-income.js"></script>

    <!-- Validation -->
    <script src="validation/input-validator.js"></script>

    <!-- Chart builders -->
    <script src="charts/retirement-projection-chart.js"></script>
    <script src="charts/lifecycle-chart-builder.js"></script>
    <script src="charts/cash-flow-chart-builder.js"></script>

    <!-- Auth & User Data -->
    <script src="utils/auth.js"></script>
    <script src="utils/user-data.js"></script>

    <!-- Application orchestrator (must load last) -->
    <script src="app.js"></script>

    <!-- Auth header + save/load wiring -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Update header auth link
        function updateAuthLink() {
            const link = document.getElementById('headerAuthLink');
            if (!link) return;
            const user = Auth.getCurrentUser();
            if (user) {
                link.textContent = 'ğŸ‘¤ ' + user.firstName;
                link.title = 'Logged in as ' + user.email;
            } else {
                link.textContent = 'ğŸ”‘ Login';
                link.title = 'Sign in or create an account';
            }
        }
        updateAuthLink();

        // Save/Load bar visibility
        var saveLoadBar = document.getElementById('saveLoadBar');
        var saveBtn = document.getElementById('saveDataBtn');
        var loadBtn = document.getElementById('loadDataBtn');
        var saveLoadMsg = document.getElementById('saveLoadMsg');

        function updateSaveLoadBar() {
            if (!saveLoadBar) return;
            if (Auth.isLoggedIn()) {
                saveLoadBar.style.display = '';
                var lastSaved = UserData.getLastSaved();
                if (lastSaved) {
                    saveLoadMsg.textContent = 'Last saved: ' + new Date(lastSaved).toLocaleString('en-GB');
                    saveLoadMsg.style.display = '';
                } else {
                    saveLoadMsg.style.display = 'none';
                }
            } else {
                saveLoadBar.style.display = 'none';
            }
        }
        updateSaveLoadBar();

        // Auto-load on page load if logged in and has saved data
        if (Auth.isLoggedIn() && UserData.hasSavedData()) {
            var result = UserData.loadFormData();
            if (result.loaded) {
                saveLoadMsg.textContent = 'âœ… Data loaded â€” last saved: ' + new Date(result.savedAt).toLocaleString('en-GB');
                saveLoadMsg.style.display = '';
            }
        }

        // Save button
        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                var result = UserData.saveFormData();
                if (result.success) {
                    saveLoadMsg.textContent = 'âœ… Saved at ' + new Date().toLocaleString('en-GB');
                    saveLoadMsg.style.display = '';
                } else {
                    saveLoadMsg.textContent = 'âŒ ' + result.error;
                    saveLoadMsg.style.display = '';
                }
            });
        }

        // Load button
        if (loadBtn) {
            loadBtn.addEventListener('click', function () {
                var result = UserData.loadFormData();
                if (result.loaded) {
                    saveLoadMsg.textContent = 'âœ… Data loaded â€” last saved: ' + new Date(result.savedAt).toLocaleString('en-GB');
                    saveLoadMsg.style.display = '';
                } else if (result.error) {
                    saveLoadMsg.textContent = 'âŒ ' + result.error;
                    saveLoadMsg.style.display = '';
                } else {
                    saveLoadMsg.textContent = 'No saved data found.';
                    saveLoadMsg.style.display = '';
                }
            });
        }

        // â”€â”€ Auto-save on input change (debounced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        var _autoSaveTimer = null;
        function autoSave() {
            if (!Auth.isLoggedIn()) return;
            if (_autoSaveTimer) clearTimeout(_autoSaveTimer);
            _autoSaveTimer = setTimeout(function () {
                var result = UserData.saveFormData();
                if (result.success && saveLoadMsg) {
                    saveLoadMsg.textContent = 'ğŸ’¾ Auto-saved at ' + new Date().toLocaleString('en-GB');
                    saveLoadMsg.style.display = '';
                }
            }, 1500);
        }

        // Listen for changes on all tracked form fields
        UserData.FIELDS.forEach(function (field) {
            if (field.type === 'radio') {
                document.querySelectorAll('input[name="' + field.name + '"]').forEach(function (el) {
                    el.addEventListener('change', autoSave);
                });
            } else {
                var el = document.getElementById(field.id);
                if (el) {
                    el.addEventListener('change', autoSave);
                    if (el.tagName === 'INPUT' && el.type !== 'checkbox') {
                        el.addEventListener('input', autoSave);
                    }
                }
            }
        });
    });
    </script>
</body>
</html>
